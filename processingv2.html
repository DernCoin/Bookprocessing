<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Book Processing Dashboard v2.0 (Priority)</title>

<script src="https://cdn.jsdelivr.net/npm/jsbarcode@3.11.6/dist/JsBarcode.all.min.js"></script>

<style>
  :root{
    --paper: 80mm;
    --border:#ddd;
    --bg:#fafafa;
    --muted:#666;
  }

  body{
    font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
    background: var(--bg);
    margin: 18px;
    color:#111;
  }

  .app{
    display:grid;
    grid-template-columns: 1fr 420px;
    gap:16px;
    align-items:start;
  }

  .panel{
    background:#fff;
    border:1px solid var(--border);
    border-radius:10px;
    padding:14px;
    box-shadow: 0 1px 3px rgba(0,0,0,.05);
  }

  h1{font-size:18px;margin:0 0 10px;}
  h2{font-size:14px;margin:10px 0;color:#222;}
  h3{font-size:13px;margin:12px 0 8px;color:#222;}

  .tabs{
    display:flex;
    gap:8px;
    margin-bottom:12px;
  }

  .tabButton{
    padding:8px 12px;
    border-radius:999px;
    border:1px solid var(--border);
    background:#fff;
    color:#222;
    font-weight:700;
    cursor:pointer;
  }

  .tabButton.active{
    background:#111;
    color:#fff;
    border-color:#111;
  }

  .tabPanel{ display:none; }
  .tabPanel.active{ display:block; }

  .section{
    border:1px solid #eee;
    border-radius:12px;
    padding:12px;
    background:#fcfcfc;
    margin-bottom:12px;
  }

  .row{
    display:grid;
    grid-template-columns: 150px 1fr;
    gap:10px;
    margin-bottom:10px;
    align-items:center;
  }

  input[type="text"], input[type="number"], select{
    padding:8px 10px;
    border:1px solid var(--border);
    border-radius:8px;
    font-size:14px;
    width:100%;
    box-sizing:border-box;
    background:#fff;
  }

  .mono{
    font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace;
  }

  .btnRow{
    display:grid;
    grid-template-columns: 1fr 1fr;
    gap:10px;
    margin-top:10px;
  }

  button{
    padding:10px 12px;
    border-radius:10px;
    border:1px solid var(--border);
    background:#111;
    color:#fff;
    font-weight:750;
    cursor:pointer;
  }
  button.secondary{
    background:#fff;
    color:#111;
    font-weight:700;
  }
  button.danger{
    background:#b00020;
    border-color:#b00020;
  }
  button:active{transform: translateY(1px);}

  .hint{
    color: var(--muted);
    font-size:12px;
    line-height:1.35;
    margin-top:8px;
  }

  .filters{
    display:grid;
    grid-template-columns: 1fr 1fr 1fr;
    gap:10px;
    margin: 8px 0 10px;
  }

  /* Table */
table{
    width:100%;
    border-collapse:collapse;
    font-size:13px;
    margin-top:10px;
    background:#fff;
  }
  th, td{
    border-bottom:1px solid #eee;
    padding:10px 8px;
    vertical-align:top;
  }
  th{ text-align:left; font-size:12px; color:#333; }
  td{ line-height:1.4; }
  tr:hover td{ background:#fafafa; }

  .tableWrap{
    overflow:auto;
    border:1px solid #eee;
    border-radius:12px;
    padding:6px;
    background:#fff;
  }

  .pill{
    display:inline-block;
    padding:3px 8px;
    border-radius:999px;
    border:1px solid #ddd;
    font-size:12px;
    font-weight:800;
    background:#fff;
    white-space:nowrap;
  }
  .pill.yes{ border-color:#0b6; color:#0b6; }
  .pill.no{ border-color:#999; color:#333; }
  .pill.special{ border-color:#b00020; color:#b00020; }
  .pill.done{ border-color:#0b6; color:#0b6; }
  .pill.warn{ border-color:#b8860b; color:#7a5a00; }

  .actions{
    display:flex;
    gap:8px;
    flex-wrap:wrap;
  }
  .smallBtn{
    padding:6px 10px;
    border-radius:10px;
    font-size:12px;
  }

  .hidden{ display:none !important; }

  /* ===== Aging heat (subtle ramp) ===== */
  .age0 td{ background:#fff; }
  .age1 td{ background:#fffdf6; }
  .age2 td{ background:#fff9e8; }
  .age3 td{ background:#fff3d5; }
  .age4 td{ background:#ffe8ba; }

  /* ===== Receipt styles ===== */
  .receiptWrap{
    display:grid;
    justify-content:center;
  }

 .receipt{
    width: var(--paper);
    background:#fff;
    border:1px solid var(--border);
    border-radius:10px;
    padding:10px;
    box-sizing:border-box;

    font-family: "Courier New", Courier, monospace;
    font-size: 13px;
    font-weight: 700;
    line-height: 1.25;

    image-rendering: pixelated;
    -webkit-font-smoothing: none;
    font-smooth: never;
  }

  .r-title{
    text-align:center;
    font-size:18px;
    font-weight:900;
    letter-spacing: .4px;
    margin: 2px 0 6px;
  }

  .r-special{
    text-align:center;
    font-size:16px;
    font-weight:900;
    margin: 2px 0 6px;
  }

  .r-rule{
    border-top:1px dashed #000;
    margin:6px 0;
  }

  .r-line{
    display:flex;
    justify-content:space-between;
    gap:10px;
    margin: 2px 0;
  }

  .r-left{ flex:1; overflow-wrap:anywhere; }
  .r-right{ white-space:nowrap; font-weight:900; }

  .r-block{
    margin-top:6px;
    font-weight:900;
  }

  .r-sub{
    font-weight:700;
 }

  /* ===== Bookplate styles ===== */
  .bookplateSheet{
    width: 8.5in;
    height: 11in;
    margin: 0 auto;
    display: grid;
    grid-template-columns: repeat(2, 3in);
    grid-template-rows: repeat(3, 3.75in);
    justify-content: space-between;
    align-content: space-between;
    padding: 0.25in 0.35in;
    box-sizing: border-box;
    background: #fff;
    border: 1px solid var(--border);
    border-radius: 12px;
  }

  .bookplateLabel{
    position: relative;
    width: 3.75in;
    height: 3in;
    box-sizing: border-box;
    display: flex;
    align-items: center;
    justify-content: center;
    text-align: center;
    font-weight: 700;
    letter-spacing: 0.2px;
  }

  .bookplateLabel.empty{
    background: #f5f5f5;
    border: 1px dashed #ddd;
  }

  .bookplateBorder{
    position: absolute;
    inset: 0;
    width: 100%;
    height: 100%;
    object-fit: fill;
    display: block;
    pointer-events: none;
  }

  .bookplateContent{
    position: relative;
    z-index: 1;
    padding: var(--plate-padding, 16px);
    width: 100%;
    box-sizing: border-box;
    display: grid;
    gap: 6px;
  }

  .bookplateLine{
    font-size: 18px;
    font-weight: 700;
  }

  .bookplateLine.template{
    font-size: 15px;
    text-transform: uppercase;
    letter-spacing: 0.8px;
  }

  .bookplatePreviewHint{
    margin-top: 10px;
    color: var(--muted);
    font-size: 12px;
  }

  @media print{
    body{ margin:0; background:#fff; }
    body.print-bookplates .panel{ display:none !important; }
    body.print-bookplates .bookplatePrintPanel{ display:block !important; }
    body:not(.print-bookplates) .panel:not(.printpanel){ display:none !important; }
    .printpanel h2{ display:none !important; }
    body.print-bookplates{
      -webkit-print-color-adjust: exact;
      print-color-adjust: exact;
    }
    .receipt{
      border:none;
      border-radius:0;
      padding:0;
      page: slip;
    }
    body.print-bookplates .bookplateSheet{
      border:none;
      border-radius:0;
      padding:0.25in 0.35in;
      page: bookplates;
    }
  }

  @page slip{
    size: 80mm auto;
    margin: 4mm;
  }

  @page bookplates{
    size: letter;
    margin: 0;
  }
</style>
</head>

<body>
<div class="app">

<!-- LEFT -->
  <div class="panel">
    <h1>Book Processing Dashboard v2.0</h1>

   <div class="tabs" role="tablist">
      <button class="tabButton active" type="button" data-tab="processing">Processing</button>
      <button class="tabButton" type="button" data-tab="orders">Book Orders</button>
      <button class="tabButton" type="button" data-tab="bookplates">Bookplates</button>
      <button class="tabButton" type="button" data-tab="settings">Settings</button>
    </div>

    <div id="tab-processing" class="tabPanel active">
      <div class="section">
        <h2>Scan / Find</h2>
        <div class="row">
          <label for="scan">Scan barcode</label>
          <input id="scan" class="mono" type="text" placeholder="Scan here (Enter loads/creates)" />
        </div>

        <div class="row">
          <label for="search">Search</label>
          <input id="search" type="text" placeholder="Title or barcode…" />
        </div>

        <div class="filters">
          <div>
            <label for="filterSpecial" style="font-size:13px;">Special handling</label>
            <select id="filterSpecial">
              <option value="">All</option>
              <option value="1">Special only</option>
              <option value="0">Not special</option>
            </select>
          </div>

          <div>
            <label for="showDone" style="font-size:13px;">Done items</label>
            <select id="showDone">
              <option value="0">Hide done</option>
              <option value="1">Show done</option>
            </select>
          </div>

          <div>
            <label for="viewMode" style="font-size:13px;">View</label>
            <select id="viewMode">
              <option value="all">All</option>
              <option value="top10">Top 10 priority</option>
            </select>
          </div>
        </div>

        <div class="hint">
          Priority score is automatic. Aging points only apply when <strong>Received=YES</strong> and the item is not Done.
        </div>
      </div>

      <div class="section">
        <h2>Item editor</h2>

        <div class="row">
          <label for="barcode">Barcode</label>
          <input id="barcode" class="mono" type="text" placeholder="ISBN placeholder or real barcode" />
        </div>

        <div class="row">
          <label for="title">Title</label>
          <input id="title" type="text" placeholder="Title" />
        </div>

        <div class="row">
          <label for="author">Author</label>
          <input id="author" type="text" placeholder="Author" />
        </div>

         <div class="row">
          <label for="workType">Work type</label>
          <select id="workType">
            <option value="NEW">New processing</option>
            <option value="FIX">General fixes</option>
          </select>
        </div>

        <div class="row generalFixHide">
          <label for="received">Received</label>
          <select id="received">
            <option>NO</option>
            <option>YES</option>
          </select>
        </div>

        <h3 class="generalFixHide">Processing Status (YES/NO)</h3>

        <div class="row generalFixHide">
          <label for="cataloged">Cataloged</label>
          <select id="cataloged"><option>NO</option><option>YES</option></select>
        </div>

        <div class="row generalFixHide">
          <label for="spine">Spine label</label>
          <select id="spine"><option>NO</option><option>YES</option></select>
        </div>

        <div class="row generalFixHide">
          <label for="covered">Covered</label>
          <select id="covered"><option>NO</option><option>YES</option></select>
        </div>

        <h3 class="generalFixHide">Context</h3>

        <div class="row generalFixHide">
          <label for="holdName">Hold for</label>
          <input id="holdName" type="text" placeholder="Name (blank = no hold)" />
        </div>

        <div class="row generalFixHide">
          <label for="adoptedAmt">Adopted $</label>
          <input id="adoptedAmt" type="number" min="0" step="0.01" placeholder="0.00" />
        </div>

        <div class="row generalFixHide">
          <label for="bookplate">Bookplate printed</label>
          <select id="bookplate"><option>NO</option><option>YES</option></select>
        </div>

        <div class="row generalFixHide">
          <label for="donated">Donated</label>
          <input id="donated" type="text" placeholder="Donor name (blank = no donation)" />
        </div>

        <div class="row generalFixHide">
          <label for="memorial">Memorial</label>
          <input id="memorial" type="text" placeholder="In memory/honor of" />
        </div>

        <div class="row generalFixHide">
          <label for="itemNotes">Notes</label>
          <input id="itemNotes" type="text" placeholder="Item notes for slip" />
        </div>

        <div class="row generalFixHide">
          <label for="manualDone">Mark done manually</label>
          <input id="manualDone" type="checkbox" />
        </div>

        <div id="fixDetailsRow" class="row hidden generalFixOnly">
          <label for="fixDetails">Fixes needed</label>
          <input id="fixDetails" type="text" placeholder="Describe required fixes" />
        </div>

        <div id="fixDoneRow" class="row hidden generalFixOnly">
          <label for="fixDone">Fix done</label>
          <input id="fixDone" type="checkbox" />
        </div>

        <h3>Slip tracking</h3>

        <div class="row">
          <label for="slipPrinted">Slip printed</label>
          <input id="slipPrinted" type="text" disabled />
        </div>

        <div class="row">
          <label for="printedAt">Printed for</label>
          <input id="printedAt" type="text" disabled />
        </div>

        <div class="btnRow">
          <button onclick="printSlip()">Print slip</button>
          <button class="secondary" onclick="saveItem()">Save item</button>
        </div>

        <div class="btnRow">
          <button class="secondary" onclick="clearEditor()">Clear</button>
          <button class="danger" onclick="deleteItem()">Delete</button>
        </div>
      </div>

      <div class="section">
        <h2>Items</h2>
        <div id="summary" class="hint"></div>
        <div class="tableWrap">
          <table>
            <thead>
              <tr>
                <th>Priority</th>
                <th>Done</th>
                <th>Title</th>
                <th>Barcode</th>
                <th>Flags</th>
                <th>Slip</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody id="itemsTable"></tbody>
          </table>
        </div>
      </div>
    </div>

     <div id="tab-orders" class="tabPanel">
      <div class="section">
        <h2>Book Orders</h2>
        <div class="row">
          <label for="orderNumber">Order #</label>
          <input id="orderNumber" type="text" placeholder="Order number" />
        </div>
        <div class="row">
          <label for="orderVendor">Vendor</label>
          <input id="orderVendor" type="text" placeholder="Vendor or source" />
        </div>
        <div class="row">
          <label for="orderPlaced">Ordered on</label>
          <input id="orderPlaced" type="date" />
        </div>
        <div class="row">
          <label for="orderNotes">Notes</label>
          <input id="orderNotes" type="text" placeholder="Rush, funding source, etc." />
        </div>

        <h3>Order items</h3>
        <div class="row">
          <label for="orderItemTitle">Item title</label>
          <input id="orderItemTitle" type="text" placeholder="Item title" />
        </div>
        <div class="row">
          <label for="orderItemAuthor">Item author</label>
          <input id="orderItemAuthor" type="text" placeholder="Item author" />
        </div>
        <div class="row">
          <label for="orderItemBarcode">Item barcode</label>
          <input id="orderItemBarcode" class="mono" type="text" placeholder="Optional barcode" />
        </div>
        <div class="row">
          <label for="orderItemDonation">Donation</label>
          <input id="orderItemDonation" type="text" placeholder="Donor name (optional)" />
        </div>
        <div class="row">
          <label for="orderItemMemorial">Memorial</label>
          <input id="orderItemMemorial" type="text" placeholder="Memorial text (optional)" />
        </div>
        <div class="row">
          <label for="orderItemNotes">Item notes</label>
          <input id="orderItemNotes" type="text" placeholder="Notes to carry to processing" />
        </div>
        <div class="btnRow">
          <button class="secondary" onclick="addOrderItem()">Add item</button>
        </div>
        <div class="tableWrap">
          <table>
            <thead>
              <tr>
                <th>Item</th>
                <th>Author</th>
                <th>Barcode</th>
                <th>Donation</th>
                <th>Memorial</th>
                <th>Notes</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody id="orderItemsTable"></tbody>
          </table>
        </div>

        <div class="btnRow">
          <button class="secondary" onclick="saveOrder()">Save order</button>
          <button class="secondary" onclick="clearOrder()">Clear</button>
        </div>

        <div class="btnRow">
          <button class="danger" onclick="deleteOrder()">Delete</button>
        </div>
      </div>

      <div class="section">
        <h2>Orders</h2>
        <div id="ordersSummary" class="hint"></div>
        <div class="tableWrap">
          <table>
            <thead>
              <tr>
                <th>Order #</th>
                <th>Vendor</th>
                <th>Ordered</th>
                <th>Items</th>
                <th>Notes</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody id="ordersTable"></tbody>
          </table>
        </div>
      </div>
    </div>

    <div id="tab-bookplates" class="tabPanel">
      <div class="section">
        <h2>Bookplate generator</h2>

        <div class="row">
          <label for="bookplateTemplate">Template</label>
          <select id="bookplateTemplate">
            <option value="donated">Donated by</option>
            <option value="memory">In memory of</option>
            <option value="given">Given by</option>
          </select>
        </div>

        <div class="row">
          <label for="bookplateLine1">Name line 1</label>
          <input id="bookplateLine1" type="text" placeholder="Name" />
        </div>

        <div class="row">
          <label for="bookplateLine2">Name line 2</label>
          <input id="bookplateLine2" type="text" placeholder="Optional second line" />
        </div>
      </div>

      <div class="section">
        <h2>Print options</h2>
        <div class="row">
          <label for="bookplateFillSheet">Fill sheet (6)</label>
          <input id="bookplateFillSheet" type="checkbox" checked />
        </div>
        <div class="row">
          <label for="bookplateStartPos">Start position</label>
          <select id="bookplateStartPos">
            <option value="1">1 (Top left)</option>
            <option value="2">2 (Top right)</option>
            <option value="3">3 (Middle left)</option>
            <option value="4">4 (Middle right)</option>
            <option value="5">5 (Bottom left)</option>
            <option value="6">6 (Bottom right)</option>
          </select>
        </div>
        <div class="btnRow">
          <button type="button" onclick="printBookplates()">Print bookplates</button>
          <button class="secondary" type="button" onclick="clearBookplateForm()">Clear</button>
        </div>
      </div>

      <div class="section">
        <h2>Border</h2>
        <div class="row">
          <label for="bookplateBorderOn">Show border</label>
          <input id="bookplateBorderOn" type="checkbox" checked />
        </div>
        <div class="row">
          <label for="bookplateBorderSelect">Border image</label>
          <select id="bookplateBorderSelect"></select>
        </div>
        <div class="row">
          <label>Preview</label>
          <img id="bookplateBorderPreview" alt="Border preview" style="max-width:120px;max-height:120px;border:1px solid #eee;border-radius:8px;background:#fff;" />
        </div>
        <div class="row">
          <label for="bookplatePadding">Text padding</label>
          <div>
            <input id="bookplatePadding" type="range" min="0" max="40" step="1" value="16" />
            <div class="hint">Padding: <span id="bookplatePaddingValue">16</span>px</div>
          </div>
        </div>
      </div>
    </div>

    <div id="tab-settings" class="tabPanel">
      <div class="section">
        <h2>Data management</h2>
        <div class="row">
          <label>Last export</label>
          <div class="mono" id="lastExportStamp">Never</div>
        </div>
        <div class="btnRow">
          <button class="secondary" onclick="exportAllData()">Export all data</button>
          <button class="secondary" onclick="triggerImport()">Import data</button>
        </div>
        <input id="importFile" type="file" accept="application/json" class="hidden" />
        <div class="hint">
          Export downloads a JSON backup of all items and orders. Import replaces the current dataset with the file contents.
       </div>
      </div>

      <div class="section">
        <h2>Bookplate borders</h2>
        <div class="row">
          <label for="borderUpload">Upload border</label>
          <input id="borderUpload" type="file" accept="image/*" />
        </div>
        <div class="hint">
          Upload transparent PNG, GIF, or JPG borders. These are stored locally in this browser.
        </div>
        <div id="borderList" class="tableWrap" style="margin-top:10px;"></div>
      </div>
    </div>
  </div>

  <!-- RIGHT: receipt -->
  <div class="panel printpanel" id="slipPreviewPanel">
    <h2>Slip Preview</h2>
    <div class="receiptWrap">
      <div class="receipt" id="receipt">
        <div id="rSpecialTop" class="r-special hidden">⚠ SPECIAL HANDLING</div>

        <div class="r-title">PROCESSING STATUS</div>
         <div class="r-rule"></div>

        <div id="rTitleBlock" class="r-block hidden"></div>

        <div class="r-line"><div class="r-left r-sub">Work type</div><div class="r-right" id="rWorkType"></div></div>
        <div class="r-line"><div class="r-left r-sub">Received</div><div class="r-right" id="rReceived"></div></div>
        <div class="r-line"><div class="r-left r-sub">Cataloged</div><div class="r-right" id="rCataloged"></div></div>
        <div class="r-line"><div class="r-left r-sub">Spine label</div><div class="r-right" id="rSpine"></div></div>
        <div class="r-line"><div class="r-left r-sub">Covered</div><div class="r-right" id="rCovered"></div></div>

        <div class="r-rule"></div>

        <div id="rHoldRow" class="r-line hidden">
          <div class="r-left r-sub">HOLD</div><div class="r-right" id="rHoldName"></div>
        </div>

        <div id="rAdoptedRow" class="r-line hidden">
          <div class="r-left r-sub">ADOPTED</div><div class="r-right" id="rAdoptedAmt"></div>
        </div>

        <div id="rBookplateRow" class="r-line hidden">
          <div class="r-left r-sub">BOOKPLATE</div><div class="r-right" id="rBookplate"></div>
        </div>

        <div id="rDonatedRow" class="r-line hidden">
          <div class="r-left r-sub">DONATION</div><div class="r-right" id="rDonatedName"></div>
        </div>

        <div id="rMemorialRow" class="r-line hidden">
          <div class="r-left r-sub">MEMORIAL</div><div class="r-right" id="rMemorial"></div>
        </div>

        <div id="rNotesRow" class="r-line hidden">
          <div class="r-left r-sub">NOTES</div><div class="r-right" id="rNotes"></div>
        </div>

        <div class="r-rule"></div>

        <svg id="barcodeSvg"></svg>
        <div class="r-line">
          <div class="r-left r-sub">Barcode</div>
          <div class="r-right" id="rBarcodeText"></div>
        </div>

        <div class="r-rule"></div>

        <div class="r-line">
          <div class="r-left r-sub">Printed for</div>
          <div class="r-right" id="rPrintedAt"></div>
        </div>
      </div>
    </div>
  </div>

  <div class="panel printpanel hidden bookplatePrintPanel" id="bookplatePreviewPanel">
    <h2>Bookplate Preview</h2>
    <div class="bookplateSheet" id="bookplateSheet"></div>
    <div class="bookplatePreviewHint">
      Avery 6874 labels (3&quot; x 3 3/4&quot;), 2 columns × 3 rows. For best print/PDF output, set margins to None and disable headers/footers in the print dialog.
    </div>
  </div>

</div>

<script>
  const $ = (id) => document.getElementById(id);

 const STORAGE_KEY = "bp_v2_priority";
  const EXPORT_TIMESTAMP_KEY = "bp_v2_priority_last_export";
 const defaultData = { items: [], orders: [], bookplateBorders: [] };
  let data = loadData();
  let activeId = null;
  let activeOrderId = null;
  let orderItems = [];

  function loadData(){
    try{
      const raw = localStorage.getItem(STORAGE_KEY);
      if(!raw) return structuredClone(defaultData);
      const parsed = JSON.parse(raw);
       parsed.items ??= [];
      parsed.orders ??= [];
      parsed.bookplateBorders ??= [];
      return parsed;
    }catch{
      return structuredClone(defaultData);
    }
  }

 function persist(){
    localStorage.setItem(STORAGE_KEY, JSON.stringify(data));
    renderTable();
    renderOrders();
    syncReceipt();
    renderBookplateBorders();
    renderBookplateSheet();
    renderSettings();
  }

  function uid(){
    return "item_" + Math.random().toString(16).slice(2) + Date.now().toString(16);
  }

  function orderUid(){
    return "order_" + Math.random().toString(16).slice(2) + Date.now().toString(16);
  }

  function isDone(it){
    if(it.manualDone === true) return true;
    if(isGeneralFix(it) && it.fixDone === true) return true;
    return (it.received === "YES" &&
            it.cataloged === "YES" &&
            it.spine === "YES" &&
            it.covered === "YES");
  }

  function isGeneralFix(it){
    return (it.workType || "NEW") === "FIX";
  }

  function hasHold(it){
    return (it.holdName || "").trim().length > 0;
  }

  function hasAdopted(it){
    const n = Number(it.adoptedAmt);
    return isFinite(n) && n > 0;
  }

  function isSpecial(it){
    // Special-handling triggers: hold OR adopted OR donated OR memorial
    return hasHold(it) || hasAdopted(it) || hasDonation(it) || hasMemorial(it);
  }

  function hasDonation(it){
    return (it.donated || "").trim().length > 0;
  }

  function hasMemorial(it){
    return (it.memorial || "").trim().length > 0;
  }

  function formatMoney(v){
    const n = Number(v);
    if(!isFinite(n) || n <= 0) return "";
    return "$" + n.toFixed(2);
  }

 function nowStamp(){
    const d = new Date();
    return d.toLocaleString([], { year:"numeric", month:"numeric", day:"numeric", hour:"numeric", minute:"2-digit" });
  }

  function getLastExportStamp(){
    return localStorage.getItem(EXPORT_TIMESTAMP_KEY) || "";
  }

  function setLastExportStamp(value){
    localStorage.setItem(EXPORT_TIMESTAMP_KEY, value);
    renderSettings();
  }

   function renderSettings(){
    const stamp = getLastExportStamp();
    $("lastExportStamp").textContent = stamp || "Never";
  }

  const bookplateTemplates = {
    donated: "Donated by",
    memory: "In memory of",
    given: "Given by"
  };

  function renderBookplateBorders(){
    const select = $("bookplateBorderSelect");
    const list = $("borderList");
    const borders = data.bookplateBorders || [];
    const previousSelection = select.value;

    select.innerHTML = "";
    if(borders.length === 0){
      const option = document.createElement("option");
      option.value = "";
      option.textContent = "No borders uploaded";
      select.appendChild(option);
    }else{
      const emptyOption = document.createElement("option");
      emptyOption.value = "";
      emptyOption.textContent = "No border";
      select.appendChild(emptyOption);
      borders.forEach(border => {
        const option = document.createElement("option");
        option.value = border.id;
        option.textContent = border.name || "Border";
        select.appendChild(option);
      });
    }

    if(previousSelection && borders.find(border => border.id === previousSelection)){
      select.value = previousSelection;
    }else{
      select.value = "";
    }

    updateBookplateBorderPreview();

    if(!list) return;
    if(borders.length === 0){
      list.innerHTML = `<div class="hint">No borders uploaded yet.</div>`;
      return;
    }

    const table = document.createElement("table");
    table.innerHTML = `
      <thead>
        <tr>
          <th>Preview</th>
          <th>Name</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody></tbody>
    `;
    const tbody = table.querySelector("tbody");
    borders.forEach(border => {
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td><img src="${border.dataUrl}" alt="${escapeHTML(border.name || "Border")}" style="max-width:80px;max-height:80px;border:1px solid #eee;border-radius:6px;background:#fff;" /></td>
        <td>${escapeHTML(border.name || "")}</td>
        <td>
          <div class="actions">
            <button class="smallBtn danger" onclick="removeBorder('${border.id}')">Delete</button>
          </div>
        </td>
      `;
      tbody.appendChild(tr);
    });
    list.innerHTML = "";
    list.appendChild(table);
  }

  function updateBookplateBorderPreview(){
    const preview = $("bookplateBorderPreview");
    if(!preview) return;
    const borders = data.bookplateBorders || [];
    const selected = borders.find(border => border.id === $("bookplateBorderSelect").value);
    preview.src = selected?.dataUrl || "";
    preview.style.visibility = selected ? "visible" : "hidden";
  }

  function removeBorder(id){
    data.bookplateBorders = (data.bookplateBorders || []).filter(border => border.id !== id);
    persist();
  }

  function getBookplateState(){
    return {
      template: $("bookplateTemplate").value,
      line1: $("bookplateLine1").value.trim(),
      line2: $("bookplateLine2").value.trim(),
      fillSheet: $("bookplateFillSheet").checked,
      startPos: Number($("bookplateStartPos").value || 1),
      borderOn: $("bookplateBorderOn").checked,
      borderId: $("bookplateBorderSelect").value,
      padding: Number($("bookplatePadding").value || 0)
    };
  }

  function buildBookplateLines(state){
    const templateLine = bookplateTemplates[state.template] || "Donated by";
    return [templateLine, state.line1, state.line2].filter(line => line.trim().length > 0);
  }

  function renderBookplateSheet(){
    const sheet = $("bookplateSheet");
    if(!sheet) return;
    const state = getBookplateState();
    const lines = buildBookplateLines(state);
    const borders = data.bookplateBorders || [];
    const selectedBorder = borders.find(border => border.id === state.borderId);

    sheet.style.setProperty("--plate-padding", `${state.padding}px`);
    sheet.innerHTML = "";

    for(let i = 1; i <= 6; i += 1){
      const label = document.createElement("div");
      label.className = "bookplateLabel";
      const shouldFill = state.fillSheet
        ? i >= state.startPos
        : i === state.startPos;

      if(shouldFill){
        if(state.borderOn && selectedBorder){
          const img = document.createElement("img");
          img.className = "bookplateBorder";
          img.alt = "Bookplate border";
          img.src = selectedBorder.dataUrl;
          label.appendChild(img);
        }

        const content = document.createElement("div");
        content.className = "bookplateContent";
        lines.forEach((line, index) => {
          const div = document.createElement("div");
          div.className = `bookplateLine${index === 0 ? " template" : ""}`;
          div.textContent = line;
          content.appendChild(div);
        });
        label.appendChild(content);
      }else{
        label.classList.add("empty");
      }
      sheet.appendChild(label);
    }
  }

  function clearBookplateForm(){
    $("bookplateTemplate").value = "donated";
    $("bookplateLine1").value = "";
    $("bookplateLine2").value = "";
    $("bookplateFillSheet").checked = true;
    $("bookplateStartPos").value = "1";
    $("bookplateBorderOn").checked = true;
    $("bookplatePadding").value = "16";
    $("bookplatePaddingValue").textContent = "16";
    const borders = data.bookplateBorders || [];
    $("bookplateBorderSelect").value = borders[0]?.id || "";
    updateBookplateBorderPreview();
    renderBookplateSheet();
  }

  function printBookplates(){
    document.body.classList.add("print-bookplates");
    window.print();
  }

  function escapeHTML(str){
    return String(str ?? "")
      .replaceAll("&","&amp;")
      .replaceAll("<","&lt;")
      .replaceAll(">","&gt;")
      .replaceAll('"',"&quot;")
      .replaceAll("'","&#039;");
  }

 function statusSignature(it){
    // What should reset “aging”:
    // work type + processing statuses + received + bookplate printed (since adopted workflow is real work)
    return [
      it.workType, it.received, it.cataloged, it.spine, it.covered,
      it.bookplate, it.fixDone === true ? "YES" : "NO", it.manualDone === true ? "YES" : "NO"
    ].join("|");
  }

  function daysSince(isoDate){
    if(!isoDate) return 0;
    const then = new Date(isoDate).getTime();
    if(!isFinite(then)) return 0;
    const now = Date.now();
    const ms = now - then;
    return Math.max(0, Math.floor(ms / (1000*60*60*24)));
  }

  function priorityScore(it){
    // Importance + staleness.
    // Only apply staleness when Received=YES and not done.
    let score = 0;
    const breakdown = [];

    if(hasHold(it)){ score += 60; breakdown.push("hold+60"); }
    if(hasAdopted(it)){ score += 35; breakdown.push("adopted+35"); }
    if(isGeneralFix(it)){ score += 25; breakdown.push("generalFix+25"); }

    // Bookplate avoidance helper: if adopted and bookplate NOT printed, add pressure.
    if(hasAdopted(it) && (it.bookplate || "NO") === "NO"){
      score += 20; breakdown.push("bookplate+20");
    }

    // If received and still not cataloged, nudge upward because it blocks everything.
    if(it.received === "YES" && it.cataloged === "NO"){
      score += 20; breakdown.push("notCataloged+20");
    }

    // Donation and memorial priority boosts.
    if(hasDonation(it)){
      score += 15; breakdown.push("donation+15");
    }
    if(hasMemorial(it)){
      score += 30; breakdown.push("memorial+30");
    }

    // Aging ramp
    if(it.received === "YES" && !isDone(it)){
      const d = daysSince(it.statusChangedAt);
      const daily = Math.min(40, d * 2); // +2 per day, cap 40
      if(daily > 0){ score += daily; breakdown.push(`age+${daily}`); }
      if(d >= 7){ score += 15; breakdown.push("7d+15"); }
      if(d >= 14){ score += 30; breakdown.push("14d+30"); }
    }

    return { score, breakdown };
  }

  function ageClass(it){
    // Visual ramp (only when received YES and not done)
    if(it.received !== "YES" || isDone(it)) return "age0";
    const d = daysSince(it.statusChangedAt);
    if(d >= 14) return "age4";
    if(d >= 10) return "age3";
    if(d >= 7) return "age2";
    if(d >= 3) return "age1";
    return "age0";
  }


  function toggleWorkTypeFields(){
    const isFix = $("workType").value === "FIX";
    document.querySelectorAll(".generalFixHide").forEach(el => el.classList.toggle("hidden", isFix));
    document.querySelectorAll(".generalFixOnly").forEach(el => el.classList.toggle("hidden", !isFix));
  }

   // ----------------------------
  // Editor
  // ----------------------------
  function getEditorItem(){
    return {
      id: activeId || uid(),
      barcode: $("barcode").value.trim(),
      title: $("title").value.trim(),
      author: $("author").value.trim(),

      workType: $("workType").value,
      received: $("received").value,
      cataloged: $("cataloged").value,
      spine: $("spine").value,
      covered: $("covered").value,
      manualDone: $("manualDone").checked,
      fixDetails: $("fixDetails").value.trim(),
      fixDone: $("fixDone").checked,

      holdName: $("holdName").value.trim(),
      adoptedAmt: $("adoptedAmt").value,
      bookplate: $("bookplate").value,
      donated: $("donated").value.trim(),
      memorial: $("memorial").value.trim(),
      notes: $("itemNotes").value.trim(),

      slipPrinted: ($("slipPrinted").value || "NO"),
      printedAt: ($("printedAt").value || ""),

      statusChangedAt: null,    // set on save
      statusSig: null,          // set on save
      updatedAt: new Date().toISOString()
    };
 }

  function loadIntoEditor(it){
    activeId = it.id;

    $("barcode").value = it.barcode || "";
    $("title").value = it.title || "";
    $("author").value = it.author || "";

    $("workType").value = it.workType || "NEW";
    $("received").value = it.received || "NO";
    $("cataloged").value = it.cataloged || "NO";
    $("spine").value = it.spine || "NO";
    $("covered").value = it.covered || "NO";
    $("manualDone").checked = it.manualDone === true;
    $("fixDetails").value = it.fixDetails || "";
    $("fixDone").checked = it.fixDone === true;

    $("holdName").value = it.holdName || "";
    $("adoptedAmt").value = it.adoptedAmt ?? "";
    $("bookplate").value = it.bookplate || "NO";
    $("donated").value = it.donated || "";
    $("memorial").value = it.memorial || "";
    $("itemNotes").value = it.notes || "";

    $("slipPrinted").value = it.slipPrinted || "NO";
    $("printedAt").value = it.printedAt || "";

    syncReceipt();
    toggleWorkTypeFields();
  }

  function clearEditor(){
    activeId = null;
    $("barcode").value = "";
    $("title").value = "";
    $("author").value = "";

    $("workType").value = "NEW";
    $("received").value = "NO";
    $("cataloged").value = "NO";
    $("spine").value = "NO";
    $("covered").value = "NO";
    $("manualDone").checked = false;
    $("fixDetails").value = "";
    $("fixDone").checked = false;

    $("holdName").value = "";
    $("adoptedAmt").value = "";
    $("bookplate").value = "NO";
    $("donated").value = "";
    $("memorial").value = "";
    $("itemNotes").value = "";

    $("slipPrinted").value = "NO";
    $("printedAt").value = "";

    syncReceipt();
    toggleWorkTypeFields();
    $("scan").focus();
  }

  // ----------------------------
  // Orders
  // ----------------------------
  function getEditorOrder(){
    return {
      id: activeOrderId || orderUid(),
      orderNumber: $("orderNumber").value.trim(),
      vendor: $("orderVendor").value.trim(),
      orderedOn: $("orderPlaced").value,
      notes: $("orderNotes").value.trim(),
      items: [...orderItems],
      updatedAt: new Date().toISOString()
    };
  }

  function loadIntoOrderEditor(order){
    activeOrderId = order.id;
    $("orderNumber").value = order.orderNumber || order.title || "";
    $("orderVendor").value = order.vendor || "";
    $("orderPlaced").value = order.orderedOn || "";
    $("orderNotes").value = order.notes || "";
    orderItems = Array.isArray(order.items) ? [...order.items] : [];
    renderOrderItems();
  }

  function clearOrder(){
    activeOrderId = null;
    $("orderNumber").value = "";
    $("orderVendor").value = "";
    $("orderPlaced").value = "";
    $("orderNotes").value = "";
    $("orderItemTitle").value = "";
    $("orderItemAuthor").value = "";
    $("orderItemBarcode").value = "";
    $("orderItemDonation").value = "";
    $("orderItemMemorial").value = "";
    $("orderItemNotes").value = "";
    orderItems = [];
    renderOrderItems();
  }

  function saveOrder(){
    const order = getEditorOrder();
    if(!order.orderNumber){
      alert("Order # is required.");
      $("orderNumber").focus();
      return;
    }

    const idx = data.orders.findIndex(x => x.id === order.id);
    if(idx >= 0) data.orders[idx] = order;
    else data.orders.push(order);
    syncProcessingItemsFromOrder(order);
    renderOrderItems();
    persist();
  }

  function deleteOrder(){
    if(!activeOrderId){
      alert("No order loaded.");
      return;
    }
    if(!confirm("Delete this order?")) return;
    data.orders = data.orders.filter(x => x.id !== activeOrderId);
    data.items = data.items.filter(x => x.orderId !== activeOrderId);
    clearOrder();
    persist();
  }

  function addOrderItem(){
    const title = $("orderItemTitle").value.trim();
    const author = $("orderItemAuthor").value.trim();
    const barcode = $("orderItemBarcode").value.trim();
    const donated = $("orderItemDonation").value.trim();
    const memorial = $("orderItemMemorial").value.trim();
    const notes = $("orderItemNotes").value.trim();
    if(!title && !barcode){
      alert("Enter an item title or barcode.");
      $("orderItemTitle").focus();
      return;
    }
    orderItems.push({
      id: uid(),
      title,
      author,
      barcode,
      donated,
      memorial,
      notes
    });
    $("orderItemTitle").value = "";
    $("orderItemAuthor").value = "";
    $("orderItemBarcode").value = "";
    $("orderItemDonation").value = "";
    $("orderItemMemorial").value = "";
    $("orderItemNotes").value = "";
    renderOrderItems();
  }

  function removeOrderItem(id){
    orderItems = orderItems.filter(item => item.id !== id);
    renderOrderItems();
  }

  function renderOrderItems(){
    const tbody = $("orderItemsTable");
    tbody.innerHTML = "";
    for(const item of orderItems){
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td>${escapeHTML(item.title || "")}</td>
        <td>${escapeHTML(item.author || "")}</td>
        <td class="mono">${escapeHTML(item.barcode || "")}</td>
        <td>${escapeHTML(item.donated || "")}</td>
        <td>${escapeHTML(item.memorial || "")}</td>
        <td>${escapeHTML(item.notes || "")}</td>
        <td>
          <div class="actions">
            <button class="smallBtn secondary" onclick="removeOrderItem('${item.id}')">Remove</button>
          </div>
        </td>
      `;
      tbody.appendChild(tr);
    }
  }

  function syncProcessingItemsFromOrder(order){
    const orderItemIds = new Set((order.items || []).map(item => item.id));
    data.items = data.items.filter(item => item.orderId !== order.id || orderItemIds.has(item.id));

    (order.items || []).forEach((orderItem, index) => {
      const generatedBarcode = (!orderItem.barcode && order.orderNumber)
        ? `ORDER-${order.orderNumber}-${index + 1}`
        : "";
      if(generatedBarcode){
        orderItem.barcode = generatedBarcode;
      }
      const existing = data.items.find(item => item.id === orderItem.id);
      const base = existing || {
        id: orderItem.id,
        barcode: orderItem.barcode || generatedBarcode || "",
        title: orderItem.title || "",
        author: orderItem.author || "",
        workType: "NEW",
        received: "NO",
        cataloged: "NO",
        spine: "NO",
        covered: "NO",
        manualDone: false,
        fixDetails: "",
        fixDone: false,
        holdName: "",
        adoptedAmt: "",
        bookplate: "NO",
        donated: "",
        memorial: "",
        notes: "",
        slipPrinted: "NO",
        printedAt: "",
        statusSig: ["NEW","NO","NO","NO","NO","NO","NO","NO"].join("|"),
        statusChangedAt: new Date().toISOString(),
        updatedAt: new Date().toISOString()
      };

      base.title = orderItem.title || base.title || "";
      base.author = orderItem.author || base.author || "";
      base.barcode = orderItem.barcode || base.barcode || "";
      base.donated = orderItem.donated || base.donated || "";
      base.memorial = orderItem.memorial || base.memorial || "";
      base.notes = orderItem.notes || base.notes || "";
      base.orderId = order.id;
      base.orderNumber = order.orderNumber;
      base.updatedAt = new Date().toISOString();

      if(existing){
        const index = data.items.findIndex(item => item.id === orderItem.id);
        if(index >= 0) data.items[index] = base;
      }else{
        data.items.push(base);
      }
    });
  }


  function saveItem(){
    const it = getEditorItem();
    if(!it.barcode){
      alert("Barcode is required (scan or type it).");
      $("barcode").focus();
      return;
    }

    // Merge with existing item if any
    const idx = data.items.findIndex(x => x.id === it.id);
    let prev = null;
    if(idx >= 0) prev = data.items[idx];
    else{
      const byBarcode = data.items.findIndex(x => (x.barcode||"").trim() === it.barcode);
      if(byBarcode >= 0){
        prev = data.items[byBarcode];
        it.id = prev.id;
        activeId = it.id;
      }
    }

    // Determine statusChangedAt (only if processing status signature changes)
    const newSig = statusSignature(it);
    const prevSig = prev?.statusSig ?? statusSignature(prev || it);

    if(!prev){
      it.statusSig = newSig;
      it.statusChangedAt = new Date().toISOString();
    }else{
      it.statusSig = newSig;
      it.statusChangedAt = (newSig !== prevSig) ? new Date().toISOString() : (prev.statusChangedAt || prev.updatedAt || new Date().toISOString());
      // keep slipPrinted/printedAt if not changed in editor (already there)
    }

    it.updatedAt = new Date().toISOString();

    // Upsert
    const finalIdx = data.items.findIndex(x => x.id === it.id);
    if(finalIdx >= 0) data.items[finalIdx] = it;
    else data.items.push(it);

    persist();
  }

  function deleteItem(){
    if(!activeId){
      alert("No item loaded.");
      return;
    }
    if(!confirm("Delete this item?")) return;
    data.items = data.items.filter(x => x.id !== activeId);
    clearEditor();
    persist();
  }

  // ----------------------------
  // Printing
  // ----------------------------
  function printSlip(){
    $("slipPrinted").value = "YES";
    $("printedAt").value = nowStamp();
    saveItem();
    syncReceipt();
    window.print();
  }

  // ----------------------------
  // Slip render
  // ----------------------------
  function syncReceipt(){
    const it = getEditorItem();

    $("rSpecialTop").classList.toggle("hidden", !isSpecial(it));

    const t = (it.title || "").trim();
    const author = (it.author || "").trim();
    const titleLine = [t, author].filter(Boolean).join(" — ");
   $("rTitleBlock").textContent = titleLine;
    $("rTitleBlock").classList.toggle("hidden", titleLine.length === 0);

    $("rWorkType").textContent = isGeneralFix(it) ? "GENERAL FIX" : "NEW PROCESSING";
    $("rReceived").textContent = it.received;
    $("rCataloged").textContent = it.cataloged;
    $("rSpine").textContent = it.spine;
    $("rCovered").textContent = it.covered;

    if(isGeneralFix(it)){
      $("rCataloged").textContent = it.fixDone === true ? "YES" : "NO";
      $("rSpine").textContent = "N/A";
      $("rCovered").textContent = (it.fixDetails || "").trim() || "N/A";
    }

    const hold = (it.holdName || "").trim();
    $("rHoldName").textContent = hold || "";
    $("rHoldRow").classList.toggle("hidden", hold.length === 0);

    const adoptedTxt = formatMoney(it.adoptedAmt);
    $("rAdoptedAmt").textContent = adoptedTxt;
    $("rAdoptedRow").classList.toggle("hidden", adoptedTxt.length === 0);

    // Bookplate row only if adopted
    $("rBookplate").textContent = it.bookplate || "NO";
    $("rBookplateRow").classList.toggle("hidden", adoptedTxt.length === 0);

    const donation = (it.donated || "").trim();
    $("rDonatedName").textContent = donation;
    $("rDonatedRow").classList.toggle("hidden", donation.length === 0);

    const memorial = (it.memorial || "").trim();
    $("rMemorial").textContent = memorial;
    $("rMemorialRow").classList.toggle("hidden", memorial.length === 0);

    const notes = (it.notes || "").trim();
    $("rNotes").textContent = notes;
    $("rNotesRow").classList.toggle("hidden", notes.length === 0);

    $("rBarcodeText").textContent = it.barcode || "";
    if(it.barcode){
      try{
        JsBarcode("#barcodeSvg", it.barcode, {
          format:"CODE128",
          width: 2,
          height: 44,
          displayValue: false,
          margin: 0
        });
      }catch{}
    }

    $("rPrintedAt").textContent = it.printedAt || "";
  }

  // ----------------------------
  // Table
  // ----------------------------
  function renderTable(){
    const tbody = $("itemsTable");
    tbody.innerHTML = "";

    const q = $("search").value.trim().toLowerCase();
    const filterSpecial = $("filterSpecial").value;
    const showDone = $("showDone").value === "1";
    const viewMode = $("viewMode").value;

    let items = [...data.items];

    if(q){
      items = items.filter(it =>
        (it.title || "").toLowerCase().includes(q) ||
        (it.barcode || "").toLowerCase().includes(q)
      );
    }

    if(filterSpecial === "1") items = items.filter(isSpecial);
    if(filterSpecial === "0") items = items.filter(it => !isSpecial(it));

    if(!showDone){
      items = items.filter(it => !isDone(it));
    }

    // Compute scores once for sort + display
    const scored = items.map(it => {
      const p = priorityScore(it);
      return { it, score: p.score, breakdown: p.breakdown };
    });

    // Sort by score desc, then by statusChangedAt asc? (older first), then updatedAt desc
    scored.sort((a,b) => {
      if(b.score !== a.score) return b.score - a.score;

      // If tied, older statusChangedAt first (more stuck)
      const ad = new Date(a.it.statusChangedAt || a.it.updatedAt || 0).getTime();
      const bd = new Date(b.it.statusChangedAt || b.it.updatedAt || 0).getTime();
      if(ad !== bd) return ad - bd;

      return (b.it.updatedAt || "").localeCompare(a.it.updatedAt || "");
    });

    let final = scored;
    if(viewMode === "top10"){
      final = scored.slice(0, 10);
    }

    const total = data.items.length;
    const doneCount = data.items.filter(isDone).length;
    const specialCount = data.items.filter(isSpecial).length;
    const fixesCount = data.items.filter(isGeneralFix).length;
    $("summary").textContent = `Total tracked: ${total} • Done: ${doneCount} • Special handling: ${specialCount} • General fixes: ${fixesCount}`;

    for(const row of final){
      const it = row.it;
      const done = isDone(it);
      const special = isSpecial(it);

      const flags = [];
      if(isGeneralFix(it)) flags.push(`<span class="pill warn">General Fix</span>`);
      if(special) flags.push(`<span class="pill special">Special</span>`);
      if(hasHold(it)) flags.push(`<span class="pill">Hold</span>`);
      if(hasAdopted(it)) flags.push(`<span class="pill">Adopted</span>`);
      if(hasAdopted(it) && (it.bookplate || "NO") === "NO") flags.push(`<span class="pill warn">Bookplate NO</span>`);
      if(hasDonation(it)) flags.push(`<span class="pill">Donation</span>`);
      if(hasMemorial(it)) flags.push(`<span class="pill">Memorial</span>`);
      if(it.orderNumber) flags.push(`<span class="pill">Order #${escapeHTML(it.orderNumber)}</span>`);
      if(it.manualDone === true) flags.push(`<span class="pill done">Manual done</span>`);

      const slip = (it.slipPrinted === "YES")
        ? `<span class="pill yes">Printed</span>`
        : `<span class="pill no">No slip</span>`;

      const ageD = (it.received === "YES" && !done) ? daysSince(it.statusChangedAt) : 0;
      const ageLabel = (it.received === "YES" && !done && ageD > 0) ? `Age: ${ageD}d` : "";

      const breakdown = row.breakdown.join(", ");
      const tr = document.createElement("tr");
      tr.className = ageClass(it);
      tr.innerHTML = `
        <td>
          <div class="mono" style="font-weight:900;font-size:14px;">${row.score}</div>
          <div class="hint" title="${escapeHTML(breakdown)}">${escapeHTML(ageLabel)}</div>
        </td>
        <td>${done ? `<span class="pill done">YES</span>` : `<span class="pill no">NO</span>`}</td>
        <td>${escapeHTML([it.title || "", it.author || ""].filter(Boolean).join(" — "))}</td>
        <td class="mono">${escapeHTML(it.barcode || "")}</td>
        <td>${flags.join(" ")}</td>
        <td>${slip}<div class="hint" style="margin-top:4px;">${escapeHTML(it.printedAt || "")}</div></td>
        <td>
          <div class="actions">
            <button class="smallBtn secondary" onclick="loadById('${it.id}')">Load</button>
            <button class="smallBtn secondary" onclick="loadAndPrint('${it.id}')">Print</button>
          </div>
        </td>
      `;
      tbody.appendChild(tr);
    }
  }

  function renderOrders(){
    const tbody = $("ordersTable");
    tbody.innerHTML = "";

    const orders = [...data.orders];
    const total = orders.length;
    const itemCount = orders.reduce((sum, order) => sum + (order.items?.length || 0), 0);
    $("ordersSummary").textContent = `Total orders: ${total} • Items: ${itemCount}`;

    orders.sort((a,b) => (b.updatedAt || "").localeCompare(a.updatedAt || ""));

    for(const order of orders){
      const itemsTotal = order.items?.length || 0;
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td>${escapeHTML(order.orderNumber || order.title || "")}</td>
        <td>${escapeHTML(order.vendor || "")}</td>
        <td class="mono">${escapeHTML(order.orderedOn || "")}</td>
        <td class="mono">${itemsTotal}</td>
        <td>${escapeHTML(order.notes || "")}</td>
        <td>
          <div class="actions">
            <button class="smallBtn secondary" onclick="loadOrder('${order.id}')">Load</button>
          </div>
        </td>
      `;
      tbody.appendChild(tr);
    }
  }

  function loadOrder(id){
    const order = data.orders.find(x => x.id === id);
    if(!order) return;
    loadIntoOrderEditor(order);
  }

  function loadById(id){
    const it = data.items.find(x => x.id === id);
    if(!it) return;
    loadIntoEditor(it);
    $("title").focus();
  }

  function loadAndPrint(id){
    loadById(id);
    printSlip();
  }

  // ----------------------------
  // Import / Export
  // ----------------------------
  function exportAllData(){
    const payload = {
      exportedAt: new Date().toISOString(),
      data
    };
    const blob = new Blob([JSON.stringify(payload, null, 2)], { type: "application/json" });
    const url = URL.createObjectURL(blob);
    const stamp = new Date().toISOString().slice(0, 16).replace(/[:T]/g, "-");
    const filename = `book-processing-backup-${stamp}.json`;

    const link = document.createElement("a");
    link.href = url;
    link.download = filename;
    document.body.appendChild(link);
    link.click();
    link.remove();
    URL.revokeObjectURL(url);
    setLastExportStamp(nowStamp());
  }

  function triggerImport(){
    $("importFile").value = "";
    $("importFile").click();
  }

 function normalizeImport(raw){
    const incoming = (raw && typeof raw === "object" && raw.data) ? raw.data : raw;
    const items = Array.isArray(incoming?.items) ? incoming.items.map(item => ({
      ...item,
      author: item.author || "",
      donated: item.donated || "",
      memorial: item.memorial || "",
      notes: item.notes || "",
      manualDone: item.manualDone === true,
      fixDetails: item.fixDetails || "",
      fixDone: item.fixDone === true,
      workType: item.workType || "NEW"
    })) : [];
    const orders = Array.isArray(incoming?.orders) ? incoming.orders.map(order => ({
      ...order,
      items: Array.isArray(order.items) ? order.items.map(orderItem => ({
        ...orderItem,
        author: orderItem.author || "",
        donated: orderItem.donated || "",
        memorial: orderItem.memorial || "",
        notes: orderItem.notes || ""
      })) : []
    })) : [];
    const bookplateBorders = Array.isArray(incoming?.bookplateBorders) ? incoming.bookplateBorders : [];
    return { items, orders, bookplateBorders };
  }


  // ----------------------------
  // Scan to load/create
  // ----------------------------
  $("scan").addEventListener("keydown", (e) => {
    if(e.key !== "Enter") return;
    e.preventDefault();
    const bc = $("scan").value.trim();
    if(!bc) return;

    let it = data.items.find(x => (x.barcode || "").trim() === bc) || null;

    if(!it){
       it = {
        id: uid(),
        barcode: bc,
        title: "",
        author: "",
        workType: "NEW",
        received: "NO",
        cataloged: "NO",
        spine: "NO",
        covered: "NO",
        manualDone: false,
        fixDetails: "",
        fixDone: false,
        holdName: "",
        adoptedAmt: "",
        bookplate: "NO",
        donated: "",
        memorial: "",
        notes: "",
        slipPrinted: "NO",
        printedAt: "",
        statusSig: ["NEW","NO","NO","NO","NO","NO","NO","NO"].join("|"),
        statusChangedAt: new Date().toISOString(),
        updatedAt: new Date().toISOString()
      };
      data.items.push(it);
      persist();
    }

    loadIntoEditor(it);
    $("scan").value = "";
    $("title").focus();
  });

 // Live sync (receipt only)
 ["barcode","title","author","workType","received","cataloged","spine","covered","holdName","adoptedAmt","bookplate","donated","memorial","itemNotes","manualDone","fixDetails","fixDone"].forEach(id => {
    $(id).addEventListener("input", syncReceipt);
    $(id).addEventListener("change", syncReceipt);
  });

  $("workType").addEventListener("change", toggleWorkTypeFields);

  // Filters
  ["search","filterSpecial","showDone","viewMode"].forEach(id => {
    $(id).addEventListener("input", renderTable);
    $(id).addEventListener("change", renderTable);
  });

  // Bookplate inputs
  ["bookplateTemplate","bookplateLine1","bookplateLine2","bookplateFillSheet","bookplateStartPos","bookplateBorderOn","bookplateBorderSelect"].forEach(id => {
    $(id).addEventListener("input", renderBookplateSheet);
    $(id).addEventListener("change", renderBookplateSheet);
  });

  $("bookplatePadding").addEventListener("input", () => {
    $("bookplatePaddingValue").textContent = $("bookplatePadding").value;
    renderBookplateSheet();
  });

  $("bookplateBorderSelect").addEventListener("change", () => {
    updateBookplateBorderPreview();
  });

  $("borderUpload").addEventListener("change", (event) => {
    const file = event.target.files?.[0];
    if(!file) return;
    const reader = new FileReader();
    reader.onload = () => {
      data.bookplateBorders = data.bookplateBorders || [];
      data.bookplateBorders.push({
        id: uid(),
        name: file.name,
        dataUrl: reader.result
      });
      persist();
    };
    reader.readAsDataURL(file);
    event.target.value = "";
  });

  window.addEventListener("afterprint", () => {
    document.body.classList.remove("print-bookplates");
  });

  // Init
 (function init(){
    clearEditor();
    clearOrder();
    toggleWorkTypeFields();
    renderTable();
    renderOrders();
    syncReceipt();
    renderSettings();
    renderBookplateBorders();
    clearBookplateForm();
    $("scan").focus();
  })();

  // Tabs
   document.querySelectorAll(".tabButton").forEach(btn => {
    btn.addEventListener("click", () => {
      document.querySelectorAll(".tabButton").forEach(tab => tab.classList.remove("active"));
      document.querySelectorAll(".tabPanel").forEach(panel => panel.classList.remove("active"));
      btn.classList.add("active");
      const target = btn.dataset.tab;
      const panel = document.getElementById(`tab-${target}`);
      if(panel) panel.classList.add("active");
      $("slipPreviewPanel").classList.toggle("hidden", target === "bookplates");
      $("bookplatePreviewPanel").classList.toggle("hidden", target !== "bookplates");
    });
  });

  $("importFile").addEventListener("change", async (event) => {
    const file = event.target.files?.[0];
    if(!file) return;
    try{
      const raw = await file.text();
      const parsed = JSON.parse(raw);
      if(!confirm("Importing will replace all current items and orders. Continue?")) return;
      data = normalizeImport(parsed);
      persist();
      clearEditor();
      clearOrder();
      alert("Import complete.");
    }catch{
      alert("Import failed. Please choose a valid JSON backup file.");
    }
  });
</script>
</body>
</html>

</html>

